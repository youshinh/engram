# **【資料3/8】フロントエンド基本設計書 (v1.1)**

## **1\. 概要**

本資料は、en:gram フロントエンドSPA（React \+ Vite）の全体的な構造、コンポーネント構成、状態管理の基本方針、およびビジュアルデザインの原則を定義する。

**v1.1の主な変更点:**

* AIエージェントの名称を「ACEエージェント」から「**Engrammer**」に正式変更する。  
* Engrammerとの対話フローを、LangGraph 1.0 \[cite: LangChain/LangGraph 1.0 詳細調査計画\] の「非同期・耐久実行」および「HITL（ヒューマンインザループ）」\[cite: LangChain/LangGraph 1.0 詳細調査計画\]アーキテクチャ（改善案\#1, \#2）に対応させる。  
* ビジュアルデザイン原則（すりガラス効果\[cite: d.png, l.png\]）を正式に定義する。

## **2\. ビジュアルデザイン原則 (Design Principles)**

ご提示いただいた d.png, l.png のデザインに基づき、以下のデザイン原則を定める。

* **テーマ:** 幻想的、シンプル、ミニマル、品のあるデザイン。  
* **主要効果 (Glassmorphism):**  
  * 主要なUI要素（カード、ヘッダー、モーダル）は「**すりガラス**」効果を適用する。  
  * CSSクラス .glass-card をグローバルに定義し、background-color（半透明）、backdrop-filter: blur(), border-radius, border（1pxの半透明）を適用する。  
* **レイアウト:**  
  * 十分な余白（ネガティブスペース）を確保し、情報密度を意図的に低く保つ。  
  * モバイルファーストのレスポンシブデザインを前提とする。  
* **カラーパレット:**  
  * Lightモード\[cite: l.png\]（明るい背景に半透明の白カード）とDarkモード\[cite: d.png\]（暗い背景に半透明の黒カード）を実装する。  
  * ThemeSelectorModal.tsx\[cite: ThemeSelectorModal.tsx\]により、「Light」「Dark」「System」を切り替え可能とし、localStorage\[cite: App.tsx\]に保存する。  
* **背景:** アプリ全体の背景には、InsightBloomAnimation.tsx\[cite: InsightBloomAnimation.tsx\]で描画されるような、ゆっくりと動く抽象的なニューラルネットワーク風のアニメーション（または静止画像）を配置し、「幻想的」「響創する宇宙」\[cite: Agents.md\]のテーマを表現する。  
* **タイポグラフィ:** 可読性が高く、品のあるサンセリフ体フォント（例: Inter, Noto Sans JP）を使用する。

## **3\. コンポーネント構成 (v1.1 更新)**

src/components ディレクトリに以下の主要コンポーネントを配置する。

| コンポーネント名 | 責務 | 関連するデザイン原則・機能 |
| :---- | :---- | :---- |
| **App.tsx** (Root) | 全体の司令塔。状態管理、ルーティング、バックグラウンドワーカー (useEffect) を担当。 | 全体のレイアウト（シェル）を定義。theme\[cite: App.tsx\]を\<body\>に適用。 |
| **AppHeader.tsx** | グローバルヘッダー。ナビゲーション制御、タイトル表示。 | .glass-card を適用\[cite: AppHeader.tsx\]。ミニマルなデザイン。 |
| **SideNav.tsx** | サイドナビゲーションメニュー。 | .glass-card を適用\[cite: SideNav.tsx\]。 |
| **NoteInput.tsx** | マルチモーダル（テキスト、画像、音声、*スケッチ*）入力フォーム。 | .glass-card を適用\[cite: NoteInput.tsx\]。直感的でシンプルな操作性。 |
| **MainPage.tsx** | メイン画面 (view: 'main')。NoteInputとEngrammerFlowを配置。 | アプリの「顔」。余白を大きく取る。 |
| **EngrammerFlow.tsx** (新規・またはMainPage.tsxに統合) | Engrammerとの非同期対話\[cite: LangChain/LangGraph 1.0 詳細調査計画\]を管理するUI。 | **v1.1で最も重要なUI変更。**（後述） |
| **NotesPage.tsx** | ノート一覧ページ。 | .glass-card をノートカードに適用\[cite: NotesPage.tsx\]。無限スクロール。 |
| **ConnectionsPage.tsx** | **グラフビュー**（提案\#7）を表示するページ。（React Flow等で実装） | **「響創」の視覚化**。list-view\[cite: ConnectionsPage.tsx\]から変更。 |
| **InsightsPage.tsx** | Relation\[cite: data-model.md\]の詳細管理・フィードバックページ。 | .glass-card を適用\[cite: InsightsPage.tsx\]。 |
| (Modals) | ThemeSelectorModal.tsx, HelpModal.tsx\[cite: HelpModal.tsx\], NoteModal\[cite: App.tsx\]など。 | すべて .glass-card を適用。 |

## **4\. グローバル状態管理 (App.tsx v1.1)**

App.tsx\[cite: App.tsx\]のトップレベルで、以下の状態を useState または useReducer で管理する。

* view: View: 現在表示中のページ ('main', 'notes', 'connections'など)。  
* theme: 'light' | 'dark' | 'system': 現在のUIテーマ\[cite: App.tsx\]。  
* isNavOpen: boolean: サイドナビの開閉状態\[cite: App.tsx\]。  
* allNotes, allRelations, totalNotesCount等: useLiveQuery\[cite: App.tsx\]でDexie.js\[cite: db.ts\]から取得するデータ。  
* imageUrls: Record\<string, string\>: Blob\[cite: db.ts\]から生成した画像URLのキャッシュ\[cite: App.tsx\]。

**v1.1で追加・変更する主要状態:**

* engrammerSessions: Map\<string, EngrammerSessionState\>:  
  * Engrammer\[cite: LangChain/LangGraph 1.0 詳細調査計画\]との非同期対話を管理するための新しい状態。Mapを使い、複数の対話スレッド（thread\_id\[cite: LangChain/LangGraph 1.0 詳細調査計画\]）を同時に管理できるようにする（将来的なタブUIなども視野に）。  
  * EngrammerSessionState は以下を含むオブジェクト:  
    * threadId: string: LangGraph\[cite: LangChain/LangGraph 1.0 詳細調査計画\]のthread\_id。  
    * status: 'idle' | 'generating' | 'pending\_input' | 'learning' | 'done' | 'error': Engrammerの現在の状態。  
    * query: string: ユーザーが送信したクエリ。  
    * markdownContent: string | null: Generator\[cite: ACEアルゴリズムJavaScript実装ガイド.md\]から返された（表示用の）Markdown。  
    * feedbackRefs: string\[\]: Generator\[cite: ACEアルゴリズムJavaScript実装ガイド.md\]が参照したノートID（Refボタン用\[cite: MainPage.tsx\]）。  
    * hitlPrompt: string | null: HITL（改善案\#1）でユーザーに確認を求める内容（例: 「この洞察を学習させますか？」）。  
    * errorMessage: string | null: エラーメッセージ。

## **5\. 画面遷移と主要フロー**

### **5.1. 標準ナビゲーション**

* AppHeader.tsx\[cite: AppHeader.tsx\]の「メニュー」ボタン → isNavOpen を true に → SideNav.tsx\[cite: SideNav.tsx\] 表示。  
* SideNav.tsx\[cite: SideNav.tsx\]のリンククリック → handleNavigate(view)\[cite: App.tsx\] 呼び出し → view 状態変更 → renderContent()\[cite: App.tsx\] が表示コンポーネントを切り替え。

### **5.2. Engrammer 対話フロー (v1.1 非同期・HITL対応)**

MainPage.tsx\[cite: MainPage.tsx\]上の EngrammerFlow.tsx コンポーネントがこのフローを管理する。

1. **\[ユーザー\]** Engrammer にクエリ（例: 「木工\[cite: user\_provided\_info\]のアイデアは？」）を入力し、送信ボタンを押す。  
2. **\[UI\]** callEngrammerFlow(query)\[cite: App.tsx\] を呼び出す。  
3. **\[App.tsx\]** callEngrammerFlow は engrammerFlow (Firebase Function) \[cite: engram\_backend\_api\_design.ts\] を呼び出す。  
4. **\[API\]** engrammerFlow (Function) は即座に { threadId: "xyz-123" } を返す。  
5. **\[App.tsx\]** engrammerSessions Map に { threadId: "xyz-123", status: 'generating', query: "...", ... } を追加する。  
6. **\[UI\]** EngrammerFlow.tsx は status: 'generating' を検知し、InsightBloomAnimation\[cite: InsightBloomAnimation.tsx\]とローディングスピナーを表示する。  
7. **\[App.tsx\]** getEngrammerState(threadId)\[cite: engram\_ace\_integration\_design.md\] のポーリングを開始する useEffect が起動する。  
8. **(数秒後)**  
9. **\[App.tsx\]** ポーリングが Generator\[cite: ACEアルゴリズムJavaScript実装ガイド.md\]の結果（markdownContent）と、status: 'pending\_input'（HITL\[cite: LangChain/LangGraph 1.0 詳細調査計画\]の一時停止状態）を検知する。  
10. **\[App.tsx\]** engrammerSessions の状態を更新する。  
11. **\[UI\]** EngrammerFlow.tsx は status: 'pending\_input' を検知。ローディングを停止し、markdownContent を表示。さらに、hitlPrompt に基づき「**この洞察を学習させますか？ (はい / いいえ)**」ボタン（改善案\#1）を表示する。  
12. **\[ユーザー\]** 「はい」ボタンをクリックする。  
13. **\[UI\]** continueEngrammerFlow(threadId, "approve")\[cite: engram\_ace\_integration\_design.md\] を呼び出す。  
14. **\[App.tsx\]** status を 'learning' に変更する。  
15. **\[UI\]** 「学習中...」という小さなインジケーターを表示する。  
16. **\[API\]** continueEngrammerFlow (Function) が LangGraph\[cite: LangChain/LangGraph 1.0 詳細調査計画\]を再開させ、Curator\[cite: ACEアルゴリズムJavaScript実装ガイド.md\]が実行される。  
17. **\[App.tsx\]** ポーリングが status: 'done' を検知し、セッションを完了する。