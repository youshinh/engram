# **en:gram システム概要とアーキテクチャ設計書**

バージョン: 1.0  
作成日: 2025-10-29

## **1\. システム概要**

### **1.1. プロダクト名**

en:gram

### **1.2. 目的**

ユーザーが記録した思考の断片（ノート）間の、予期せぬ、洞察に満ちた、あるいは驚きのある繋がりを発見・提示することで、ユーザーの知的創造活動を支援するパートナーとなること。

### **1.3. 主要機能**

* マルチモーダル（テキスト、画像、音声）でのノート作成・管理機能。  
* ローカルデータベース（IndexedDB）へのノートと繋がり情報の永続化。  
* ハイブリッドAI（オンデバイスAI \+ クラウドAI）によるノート間の関連性（繋がり）の自動発見・提案機能。  
* Agentic Context Engineering (ACE) に基づく自己改善型AIエージェント（Insight Bloom）との対話機能。  
* 発見された繋がりやACEの応答を管理・フィードバックする機能。  
* ノートと繋がりのグラフ可視化機能（将来実装予定、UI設計は考慮）。

### **1.4. 対象ユーザー**

個人の知的生産者、研究者、デザイナー、プランナーなど、アイデアや情報を繋げて新しい価値を生み出したいユーザー。MVP段階ではシングルユーザーを対象とする。

### **1.5. 開発背景**

Google Chrome Built-in AI Challenge 2025 への応募作品。Chrome内蔵AI（Gemini Nano）の活用が必須要件となる。

## **2\. システムアーキテクチャ**

### **2.1. 全体構成図 (概念)**

\+--------------------------------+      \+-------------------------+      \+----------------------+  
|       Frontend SPA (React)     | \---\> | Firebase Cloud Functions| \---\> | Google Cloud Services|  
|  \- UI/UX (Glassmorphism)       |      | (Genkit, LangGraph ACE) |      | (Gemini API, etc.)   |  
|  \- Client-Side AI Logic        |      \+-------------------------+      \+----------------------+  
|  \- On-Device AI (Gemini Nano)  |  
|  \- Local DB (Dexie.js/IndexedDB)|      (Cloud Fallback Path)  
\+-----------------|--------------+  
                  |  
        (Local-First Path)

### **2.2. 主要コンポーネント**

* **Frontend SPA (Single Page Application):**  
  * ReactとViteで構築されるウェブアプリケーション。  
  * ユーザーインターフェースとユーザーインタラクションを担当。  
  * クライアントサイドのAIロジック（ハイブリッドAIのオーケストレーション、類似度計算など）を含む。  
  * オンデバイスAI（Gemini Nano）との連携を行う。  
  * Dexie.jsを介してローカルのIndexedDBにアクセスし、データを永続化する。  
* **Local Database (IndexedDB via Dexie.js):**  
  * ユーザーのノート (Note) とノート間の繋がり (Relation) をクライアントサイドに保存する主要データストア。  
  * オフラインアクセスとデータプライバシーを保証する。  
* **On-Device AI (Gemini Nano via Chrome Built-in AI API):**  
  * ブラウザ内で動作するAIモデル。  
  * ノート間の繋がり発見（getInsightSuggestionsの第一経路）を実行する。  
  * プライバシーを最大限に保護し、低レイテンシで動作する。  
* **Firebase Cloud Functions:**  
  * サーバーレスバックエンド。  
  * クラウドフォールバックAIロジックをホストする (findConnectionsCloud)。  
  * コンテンツのEmbedding生成 (embedNoteUrl) を行う。  
  * ACE自己改善エージェント (aceFlow) の実行環境となる。  
  * ACEのプレイブックからノートを取得する (getPlaybookNote) 機能を提供する。  
  * Genkitフレームワークを使用してAIフローを管理する。  
* **Google Cloud Services:**  
  * Cloud Functionsから呼び出される外部サービス。  
  * Gemini API（クラウドAIモデル）、Cloud Secret Manager（APIキー管理）など。

### **2.3. 技術スタック**

* **フロントエンド:**  
  * 言語: TypeScript  
  * フレームワーク: React (\~18.x)  
  * ビルドツール: Vite  
  * 状態管理: React Hooks (useState, useEffect, useContext)  
  * ローカルDB: IndexedDB \+ Dexie.js  
  * テスト: Vitest, React Testing Library  
  * UIライブラリ: （特定のライブラリは指定しないが、アイコンはMaterial Symbols Outlinedを使用）  
  * グラフ可視化: React Flow (将来実装)  
* **バックエンド (Firebase Cloud Functions):**  
  * 言語: TypeScript  
  * ランタイム: Node.js (v20以上推奨)  
  * AIフレームワーク: Firebase Genkit, LangGraph.js (ACE実装用)  
  * デプロイ: Firebase CLI  
* **AIモデル:**  
  * オンデバイス: Gemini Nano (via Chrome Built-in AI API)  
  * クラウド: Gemini API (例: gemini-2.5-flash-lite for findConnections, gemini-pro or stronger for ACE Reflector, multimodalembedding for embedNote) ※モデルは設定で変更可能

## **3\. 主要な設計原則**

* **ローカルファースト (Local-First):** \[cite: Agents.md, en\_gram\_plan.md\]  
  * ユーザーデータは原則としてクライアントデバイスのIndexedDBに保存され、アプリケーションはオフラインでも基本的な機能（ノート閲覧・作成）が利用可能であること。  
  * AI処理も可能な限りオンデバイスで実行し、プライバシーを最大限に保護する。  
* **ハイブリッドAI (Hybrid AI):** \[cite: Agents.md, en\_gram\_plan.md, spec.md\]  
  * オンデバイスAI（Gemini Nano）を第一経路とし、利用不可能な場合にシームレスにクラウドAI（Firebase Functions）へフォールバックする。  
  * これにより、プライバシーとパフォーマンス、アクセシビリティ（ハードウェア非対応ユーザーへの対応）を両立させる。  
* **構造化出力 (Structured Output):** \[cite: Agents.md, en\_gram\_plan.md\]  
  * AI（オンデバイス、クラウド共）の出力をJSON Schema (オンデバイス) やZod Schema (クラウド) で厳密に定義し、API契約を強制する。  
  * オンデバイスとクラウドの出力スキーマは完全に同一とし、クライアントでの処理を簡素化・堅牢化する。  
* **非同期処理 (Asynchronous Processing):** \[cite: spec.md\]  
  * 時間のかかるAI処理（Embedding生成、Insight分析）はバックグラウンドで実行し、UIの応答性を維持する。  
  * 処理ステータス（embeddingStatus, insightStatus）をDBで管理する。  
* **自己改善システム (ACE):** \[cite: Agents.md, en\_gram\_plan.md, ACEアルゴリズムJavaScript実装ガイド.md\]  
  * コア機能としてAgentic Context Engineeringフレームワークを採用し、AIがユーザーのフィードバックから学習し、継続的にパフォーマンスを向上させる仕組み（プレイブック）を実装する。

## **4\. 非機能要件**

* **パフォーマンス:** \[cite: research.md\]  
  * オンデバイスAIパス (p95): \< 500ms  
  * クラウドフォールバックパス (p95): \< 2 seconds  
  * UI応答性: 60fpsを維持  
* **スケーラビリティ (MVP):** \[cite: research.md\]  
  * シングルユーザー  
  * ローカルDBで最大10,000ノートを性能劣化なく扱えること。  
* **プラットフォーム:**  
  * Google Chromeブラウザ（Gemini Nano/window.ai対応バージョン）\[cite: quickstart.md\]  
  * モバイル含むレスポンシブWebデザイン  
* **プライバシー:**  
  * ユーザーデータはローカルに保存され、明示的なクラウド機能（フォールバックAI、ACE）利用時以外はデバイス外部に送信されない。  
* **セキュリティ:**  
  * APIキーはソースコードに含めず、環境変数（ローカル開発）またはCloud Secret Manager（本番Functions）で管理する。\[cite: Agents.md\]  
  * クラウド関数へのアクセスはFirebase Authenticationで保護する。\[cite: Agents.md\]

## **5\. ターゲットプラットフォームと制約**

* **主要ターゲット:** Google Chromeブラウザの最新安定版（デスクトップおよびモバイル）  
* **必須機能:** Chrome内蔵AI API (window.ai / LanguageModelインターフェース) \[cite: hackathon\_rules.md\]  
* **制約:**  
  * オンデバイスAIの利用可否はユーザーの環境（ハードウェア、ブラウザ設定）に依存する。  
  * ハッカソン期間内にMVPを完成させる必要がある。