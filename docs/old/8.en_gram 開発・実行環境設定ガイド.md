# **【資料8/8】開発・実行環境設定ガイドの説明**

この資料 (engram\_setup\_guide.md) は、en:gram アプリケーションを開発・実行するための環境構築手順と、ローカルでの実行方法、および本番デプロイの概要について説明します。AI エージェント (LLM) がコードを生成する際に、そのコードが動作する前提となる環境を理解するために不可欠な情報です。

**主な内容:**

1. **前提条件:** 開発に必要な基本ツール (Node.js, npm, Git, Firebase CLI) と、オンデバイス AI のテストに必要な Chrome ブラウザをリストアップしています。  
2. **ブラウザ設定:** Chrome でオンデバイス AI (Gemini Nano) を有効化するための具体的なフラグ (\#prompt-api-for-gemini-nano) 設定手順を記載しています。  
3. **プロジェクトセットアップ:** Git リポジトリのクローンから、フロントエンド (npm install) とバックエンド (cd functions && npm install) の依存関係をインストールするまでの手順を示しています。  
4. **Firebase プロジェクト設定:** Firebase プロジェクトの作成、**Blaze プランへのアップグレード** (重要)、ローカル環境との紐付け (firebase use \--add)、src/firebase.ts への設定値の反映、Firestore の有効化、そして **Secret Manager を使った安全な API キー管理** の手順を詳細に説明しています。  
5. **環境変数 (.env):** フロントエンド用の .env ファイルの目的と設定例を示しています (バックエンドの機密情報は Secret Manager で管理)。  
6. **ローカル開発環境の実行:** 開発時に**同時に起動する必要がある3つのプロセス**（Vite 開発サーバー, Firebase Emulators (Functions \+ Firestore), 必要であれば ACE 専用サーバー）の起動コマンドと、エミュレータのポートや UI について説明しています。firebase.ts や Admin SDK がエミュレータを自動検出する仕組みにも言触れています。  
7. **テストの実行:** npm test コマンドで Vitest によるテストを実行する方法を記載しています。  
8. **ビルドとデプロイ:** フロントエンドのビルド (npm run build) と、Firebase への一括デプロイ (firebase deploy) の基本的なコマンドと対象サービス (Hosting, Functions, Firestore Rules, Secrets) を示しています。

LLMへの実装指示:

このガイドは、LLM が直接コードを生成する対象ではありませんが、生成されたコード (React コンポーネント、Cloud Functions など) がどのような環境設定 (Firebase プロジェクト ID、API キー管理、エミュレータ接続など) を前提としているかを理解するために使用します。例えば、firebase.ts や functions/src/index.ts を実装する際には、このガイドで説明されている Firebase プロジェクト設定や Secret Manager の利用方法を考慮する必要があります。

# **en:gram 開発・実行環境設定ガイド**

バージョン: 1.0  
作成日: 2025-10-29  
**目的:**

* en:gram アプリケーションの開発環境をセットアップし、ローカルで実行するための手順を定義する。  
* 本番環境へのデプロイ手順の概要を示す。  
* AIエージェント (LLM) が、生成したコードを実行・テストするための環境構築手順を理解できるようにする。

**参照資料:**

* quickstart.md (既存ドキュメント)  
* firebase.ts  
* package.json (フロントエンド & バックエンド)  
* firebase.json

## **1\. 前提条件 (Prerequisites)**

開発を開始する前に、以下のツールがインストールされていることを確認してください。

* **Node.js:** v20 以上 (node \-v で確認)  
* **npm:** Node.js に同梱 (npm \-v で確認)  
* **Git:** バージョン管理システム (git \--version で確認)  
* **Firebase CLI:** Firebase ツール (firebase \--version で確認)  
  * インストールされていない場合: npm install \-g firebase-tools  
  * Firebase アカウントでログイン: firebase login  
* **Google Chrome:** 最新安定版。オンデバイス AI (Gemini Nano) のテストに必要。

## **2\. ブラウザ設定 (Chrome \- オンデバイス AI 用)**

オンデバイス AI 機能 (LanguageModel API) をローカルでテストするには、以下の Chrome フラグを有効にする必要があります。

1. Chrome を起動し、アドレスバーに chrome://flags と入力して Enter キーを押します。  
2. 検索ボックスに \#prompt-api-for-gemini-nano と入力します。  
3. 表示されたフラグを **Enabled** に設定します。  
4. ブラウザ下部に表示される **Relaunch** ボタンをクリックして Chrome を再起動します。  
5. **(任意確認)** 再起動後、chrome://components にアクセスし、「Optimization Guide On Device Model」を探します。「状態 \- ダウンロード完了」または「状態 \- 更新しました」と表示されていれば、モデルが利用可能です。

## **3\. プロジェクトセットアップ**

1. **リポジトリのクローン:**  
   git clone \<repository-url\> \# Replace with actual repository URL  
   cd engram-app \# Navigate into the frontend/functions root directory

2. **フロントエンド依存関係のインストール:**  
   \# Assuming already in engram-app/  
   npm install

3. **バックエンド依存関係のインストール:**  
   cd functions  
   npm install  
   cd .. \# Return to engram-app/

## **4\. Firebase プロジェクト設定**

1. **Firebase プロジェクト作成:**  
   * Firebase コンソール ([https://console.firebase.google.com/](https://console.firebase.google.com/)) で新規プロジェクトを作成します (または既存のプロジェクトを使用)。  
   * **重要:** Cloud Functions (特に Genkit や外部 API 呼び出し) を使用するため、プロジェクトを **Blaze (従量課金) プラン** にアップグレードする必要があります。  
   * 作成したプロジェクトの **プロジェクト ID** をメモしておきます。  
2. **ローカル環境と Firebase プロジェクトの紐付け:**  
   \# In engram-app/ directory  
   firebase use \--add

   指示に従い、作成した Firebase プロジェクトを選択します。  
3. **Firebase 設定ファイル (src/firebase.ts):**  
   * src/firebase.ts ファイルを開き、firebaseConfig オブジェクトのプレースホルダー (YOUR\_API\_KEY, YOUR\_PROJECT\_ID など) を、Firebase コンソールのプロジェクト設定画面で確認できる実際の値に置き換えます。  
   * **特に projectId は、ローカルエミュレータと接続する際に重要です。**  
4. **Firestore データベース (ACE 用):**  
   * Firebase コンソールで Firestore Database を有効にします。(本番モードまたはテストモードで開始。セキュリティルールは別途設定が必要)。  
   * ACE エージェントがプレイブックを保存するために使用します (aceFlow のロジックによる)。  
5. **Secret Manager (API キー管理):**  
   * Google Cloud コンソール ([https://console.cloud.google.com/](https://console.cloud.google.com/)) で、Firebase プロジェクトに対応する Google Cloud プロジェクトを選択します。  
   * 「Secret Manager」サービスを有効にします。  
   * GEMINI\_API\_KEY という名前でシークレットを作成し、値として Google AI Studio などで取得した Gemini API キーを設定します。  
   * Cloud Functions のサービスアカウント (\<project-id\>@appspot.gserviceaccount.com) に Secret Manager の「Secret Accessor」ロール (roles/secretmanager.secretAccessor) を付与します。

## **5\. 環境変数 (.env)**

* フロントエンドのルートディレクトリ (engram-app/) に .env ファイルを作成します。  
* 現時点では、主に Vite の開発サーバー設定や、将来的にフロントエンドで使用する可能性のある公開可能なキー (例: Firebase Hosting URL) を定義します。(バックエンドの API キーは Secret Manager で管理するため、ここには含めません)。  
  \# Example for Vite port (if needed)  
  \# VITE\_PORT=3000

  \# Example for Firebase Hosting URL (after deployment)  
  \# VITE\_APP\_URL=https://\<your-project-id\>.web.app

## **6\. ローカル開発環境の実行**

ローカルでの開発・テストには、以下の3つのプロセスを**同時に**実行する必要があります (それぞれ別のターミナルウィンドウを使用)。

* **ターミナル 1: フロントエンド開発サーバー (Vite)**  
  \# In engram-app/ directory  
  npm run dev

  通常 http://localhost:5173 でアプリケーションにアクセスできます。  
* **ターミナル 2: Firebase Emulators**  
  \# In engram-app/ directory  
  \# Functions と Firestore (ACE用) のエミュレータを起動  
  firebase emulators:start \--only functions,firestore

  * Functions エミュレータは通常 localhost:5001 で、Firestore エミュレータは localhost:8080 で起動します (firebase.json で設定変更可能)。  
  * Emulator UI は通常 http://localhost:4000 でアクセスでき、動作状況の確認や Firestore データの参照/編集が可能です。  
  * src/firebase.ts 内の connectFunctionsEmulator が自動的に Functions の呼び出しをローカルエミュレータに向けます。aceFlow 関数内の Admin SDK も FUNCTIONS\_EMULATOR 環境変数を検知して Firestore エミュレータに接続します (要 functions/src/index.ts 内での実装確認)。  
* **ターミナル 3: (もしあれば) ACE 専用サーバー**  
  * aceFlow が LangGraph アプリケーションを Cloud Functions 内で直接実行する場合、このターミナルは不要です (【資料7/8】の設計)。  
  * もし ACE エージェントが別プロセス (例: Express サーバー) として実装されている場合は、その起動コマンド (例: npm run ace) をここで実行します。

## **7\. テストの実行**

* ユニットテストおよび統合テストを実行するには:  
  \# In engram-app/ directory  
  npm test

  Vitest が \*.test.ts および \*.test.tsx ファイルを実行します。db.test.ts や App.test.tsx が含まれます。

## **8\. ビルドとデプロイ (概要)**

1. **フロントエンドのビルド:**  
   \# In engram-app/ directory  
   npm run build

   dist/ ディレクトリに静的ファイルが生成されます。  
2. **Firebase へのデプロイ:**  
   \# In engram-app/ directory  
   firebase deploy \--only hosting,functions,firestore:rules,secrets

   * hosting: ビルドされたフロントエンド (dist/ ディレクトリ) をデプロイします。  
   * functions: functions/ ディレクトリ内の Cloud Functions をデプロイします。  
   * firestore:rules: Firestore のセキュリティルール (firestore.rules) をデプロイします (別途定義が必要)。  
   * secrets: Cloud Functions がアクセスする Secret Manager のシークレット設定をデプロイします。

# 

